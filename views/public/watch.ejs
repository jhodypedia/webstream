<section class="watch-page">
  <div class="player-container">
    <div class="video-box">
      <div class="video-inner">
        <video id="player" playsinline preload="metadata" webkit-playsinline></video>

        <!-- Overlay Play -->
        <div class="overlay" id="overlay">
          <button id="playBtn" class="play-btn">
            <i class="fa-solid fa-play"></i>
          </button>
        </div>

        <!-- Watermark -->
        <div class="watermark">PansaStream</div>

        <!-- Controls -->
        <div class="controls" id="controls">
          <div class="progress-bar">
            <div id="progress"></div>
          </div>
          <div class="ctrls-bottom">
            <div class="left">
              <button id="playPause" class="ctrl-btn"><i class="fa-solid fa-play"></i></button>
              <div class="vol">
                <i id="volIcon" class="fa-solid fa-volume-high"></i>
                <input id="volume" type="range" min="0" max="1" step="0.05" value="1">
              </div>
            </div>
            <button id="fullscreenBtn" class="ctrl-btn"><i class="fa-solid fa-expand"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- META -->
    <div class="video-meta">
      <h1><%= video.title %></h1>
      <div class="meta-stats">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z"/></svg>
        <span><%= video.views %> views</span>
        <span>•</span>
        <span><%= new Date(video.createdAt).toLocaleDateString('id-ID') %></span>
      </div>
      <% if (video.description) { %>
        <p class="description"><%= video.description %></p>
      <% } %>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://kit.fontawesome.com/a2d9b09d5b.js" crossorigin="anonymous"></script>
<script>
(function(){
  const video = document.getElementById('player');
  const overlay = document.getElementById('overlay');
  const playBtn = document.getElementById('playBtn');
  const playPause = document.getElementById('playPause');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const volumeSlider = document.getElementById('volume');
  const volIcon = document.getElementById('volIcon');
  const progress = document.getElementById('progress');
  const src = '<%= video.hls_master_url %>';

  // --- HLS INITIALIZATION ---
  let hls;
  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(src);
    hls.attachMedia(video);

    // 🎚️ Quality Menu
    hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
      const levels = hls.levels;
      const qmenu = document.createElement('div');
      qmenu.className = 'quality-menu';

      levels.forEach((lvl, i) => {
        const btn = document.createElement('button');
        btn.textContent = lvl.height + 'p';
        btn.onclick = () => {
          hls.currentLevel = i;
          [...qmenu.children].forEach(c=>c.classList.remove('active'));
          btn.classList.add('active');
        };
        qmenu.appendChild(btn);
      });

      const autoBtn = document.createElement('button');
      autoBtn.textContent = 'Auto';
      autoBtn.onclick = ()=>{
        hls.currentLevel = -1;
        [...qmenu.children].forEach(c=>c.classList.remove('active'));
        autoBtn.classList.add('active');
      };
      autoBtn.classList.add('active');
      qmenu.appendChild(autoBtn);

      document.querySelector('.video-inner').appendChild(qmenu);
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = src;
  }

  // --- Controls ---
  function togglePlay(){
    if (video.paused) video.play(); else video.pause();
  }
  video.addEventListener('play', ()=>{
    overlay.style.opacity=0;
    playBtn.innerHTML='<i class="fa-solid fa-pause"></i>';
    playPause.innerHTML='<i class="fa-solid fa-pause"></i>';
  });
  video.addEventListener('pause', ()=>{
    overlay.style.opacity=1;
    playBtn.innerHTML='<i class="fa-solid fa-play"></i>';
    playPause.innerHTML='<i class="fa-solid fa-play"></i>';
  });
  playBtn.onclick = togglePlay;
  playPause.onclick = togglePlay;

  // Volume
  volumeSlider.oninput = e=>{
    video.volume = e.target.value;
    volIcon.className = e.target.value==0?'fa-solid fa-volume-xmark':
      (e.target.value<0.5?'fa-solid fa-volume-low':'fa-solid fa-volume-high');
  };

  // Progress
  video.addEventListener('timeupdate', ()=>{
    progress.style.width = (video.currentTime/video.duration)*100 + '%';
  });

  // Fullscreen fix for Safari / iOS
  fullscreenBtn.onclick = ()=>{
    if (video.webkitEnterFullscreen) {
      video.webkitEnterFullscreen();
    } else if (!document.fullscreenElement) {
      video.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  };

  // Count view
  fetch('/api/videos/view/<%= video.id %>', { method:'POST' });

})();
</script>

<style>
/* === PLAYER BASE === */
.watch-page{display:flex;justify-content:center;padding:30px 0;background:var(--bg);}
.player-container{width:100%;max-width:950px;display:flex;flex-direction:column;gap:16px;}
.video-box{position:relative;aspect-ratio:16/9;background:#000;border-radius:16px;overflow:hidden;box-shadow:0 0 50px rgba(0,0,0,.5);}
.video-inner{position:relative;width:100%;height:100%;}
#player{width:100%;height:100%;object-fit:cover;background:#000;border:none;outline:none;}

/* Overlay Play */
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;transition:opacity .3s ease;}
.play-btn{background:rgba(0,0,0,.4);backdrop-filter:blur(8px);border:none;width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:30px;cursor:pointer;transition:transform .2s;}
.play-btn:hover{transform:scale(1.1);}

/* Watermark */
.watermark{
  position:absolute;bottom:10px;right:10px;
  color:rgba(255,255,255,.85);
  font-size:15px;font-weight:600;
  text-shadow:0 0 6px rgba(0,0,0,.8);
  user-select:none;
}

/* Controls */
.controls{position:absolute;bottom:0;left:0;right:0;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.85));transition:opacity .3s;}
.progress-bar{width:100%;height:6px;background:rgba(255,255,255,.15);border-radius:4px;overflow:hidden;cursor:pointer;margin-bottom:8px;}
#progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--primary));}
.ctrls-bottom{display:flex;align-items:center;justify-content:space-between;}
.left{display:flex;align-items:center;gap:10px;}
.ctrl-btn{
  background:rgba(255,255,255,.1);
  color:#fff;border:none;border-radius:8px;
  width:38px;height:38px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background .25s;
}
.ctrl-btn:hover{background:rgba(255,255,255,.25);}
.vol{display:flex;align-items:center;gap:6px;}
.vol input[type=range]{width:90px;cursor:pointer;accent-color:var(--accent);}

/* Quality Menu */
.quality-menu{
  position:absolute;top:12px;right:12px;
  display:flex;gap:6px;
  background:rgba(0,0,0,.5);
  backdrop-filter:blur(6px);
  border-radius:8px;
  padding:5px 8px;
  z-index:5;
}
.quality-menu button{
  border:none;background:transparent;color:#fff;
  font-size:13px;padding:3px 6px;border-radius:6px;
  cursor:pointer;transition:background .25s;
}
.quality-menu button:hover{background:rgba(255,255,255,.15);}
.quality-menu button.active{
  background:linear-gradient(135deg,var(--primary),var(--accent));
  color:#000;font-weight:600;
}

/* Meta */
.video-meta{text-align:left;padding:0 4px;}
.video-meta h1{font-size:clamp(22px,2.5vw,26px);margin-bottom:6px;}
.meta-stats{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:14px;margin-bottom:6px;}
.description{color:var(--muted);font-size:15px;line-height:1.5;}

/* Responsive */
@media(max-width:768px){
  .play-btn{width:70px;height:70px;font-size:24px;}
  .vol input[type=range]{width:70px;}
}
</style>
