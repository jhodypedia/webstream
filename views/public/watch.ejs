<section class="watch-page fade-in">
  <div class="player-container">
    <!-- Player -->
    <div class="video-box">
      <video id="player" playsinline preload="metadata"></video>

      <!-- Overlay -->
      <div class="overlay" id="overlay">
        <button id="playBtn" class="play-btn"><i class="fa-solid fa-play"></i></button>
      </div>

      <!-- Custom Controls -->
      <div class="controls" id="controls">
        <div class="progress-bar" id="progressBar">
          <div id="progress"></div>
        </div>
        <div class="buttons">
          <div class="left-controls">
            <button id="playCtrl" class="ctrl-btn"><i class="fa-solid fa-play"></i></button>
            <div class="volume">
              <button id="volIcon" class="ctrl-btn"><i class="fa-solid fa-volume-high"></i></button>
              <input id="volume" type="range" min="0" max="1" step="0.05" value="1">
            </div>
          </div>
          <button id="fullscreenBtn" class="ctrl-btn"><i class="fa-solid fa-expand"></i></button>
        </div>
      </div>
    </div>

    <!-- Meta -->
    <div class="video-meta">
      <h1><%= video.title %></h1>
      <div class="meta-stats">
        <svg class="ico" viewBox="0 0 24 24" width="16"><path fill="currentColor" d="M3 12s3-6 9-6 9 6 9 6-3 6-9 6-9-6-9-6zm9-3a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>
        <span id="views"><%= video.views %></span> views
        <span class="dot">â€¢</span>
        <span><%= new Date(video.createdAt).toLocaleDateString('id-ID') %></span>
      </div>
      <% if (video.description) { %>
        <p class="description"><%= video.description %></p>
      <% } %>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
<script>
(function(){
  const video = document.getElementById('player');
  const overlay = document.getElementById('overlay');
  const playBtn = document.getElementById('playBtn');
  const playCtrl = document.getElementById('playCtrl');
  const volIcon = document.getElementById('volIcon');
  const volume = document.getElementById('volume');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  const controls = document.getElementById('controls');

  const src = '<%= video.hls_master_url %>';
  if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(src);
    hls.attachMedia(video);
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = src;
  }

  const togglePlay = ()=>{
    if(video.paused) video.play(); else video.pause();
  };

  video.addEventListener('play',()=>{
    playBtn.innerHTML='<i class="fa-solid fa-pause"></i>';
    playCtrl.innerHTML='<i class="fa-solid fa-pause"></i>';
    overlay.classList.add('hide');
  });
  video.addEventListener('pause',()=>{
    playBtn.innerHTML='<i class="fa-solid fa-play"></i>';
    playCtrl.innerHTML='<i class="fa-solid fa-play"></i>';
    overlay.classList.remove('hide');
  });

  playBtn.onclick=togglePlay;
  playCtrl.onclick=togglePlay;

  volIcon.addEventListener('click',()=>{
    video.muted=!video.muted;
    volIcon.className=video.muted?'fa-solid fa-volume-xmark':'fa-solid fa-volume-high';
  });

  volume.addEventListener('input',e=>{
    video.volume=e.target.value;
    if(video.volume===0) volIcon.className='fa-solid fa-volume-xmark';
    else if(video.volume<0.5) volIcon.className='fa-solid fa-volume-low';
    else volIcon.className='fa-solid fa-volume-high';
  });

  video.addEventListener('timeupdate',()=>{
    const p=(video.currentTime/video.duration)*100;
    progress.style.width=`${p}%`;
  });

  progressBar.addEventListener('click',e=>{
    const rect=progressBar.getBoundingClientRect();
    const pos=(e.clientX-rect.left)/rect.width;
    video.currentTime=pos*video.duration;
  });

  fullscreenBtn.addEventListener('click',()=>{
    if(!document.fullscreenElement) video.parentElement.requestFullscreen();
    else document.exitFullscreen();
  });

  let timer;
  document.addEventListener('mousemove',()=>{
    controls.classList.remove('hidden');
    clearTimeout(timer);
    timer=setTimeout(()=>controls.classList.add('hidden'),3000);
  });

  fetch('/api/videos/view/<%= video.id %>',{method:'POST'})
    .then(()=>{const el=document.getElementById('views');el.textContent=(parseInt(el.textContent||'0')+1);});
})();
</script>
